<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP Audio Receiver</title>
</head>
<body>
  <h1>ESP Audio Stream</h1>
  <p id="status">Connecting to WebSocket...</p>
  <audio id="audio" controls autoplay></audio>
  <script>
    const serverHost = "<YOUR_WEBSOCKET_SERVER_HOST>"; // Replace with your WebSocket server host
    const serverPort = 8888; // WebSocket server port
    const socket = new WebSocket(`ws://${serverHost}:${serverPort}`);
    const status = document.getElementById("status");
    const audio = document.getElementById("audio");

    // WebSocket event handlers
    socket.onopen = () => {
      status.textContent = "Connected to WebSocket!";
    };

    socket.onclose = () => {
      status.textContent = "WebSocket connection closed.";
    };

    socket.onerror = (error) => {
      status.textContent = `WebSocket error: ${error.message}`;
    };

    const audioContext = new AudioContext();
    const audioBufferQueue = [];
    let sourceNode = null;

    socket.onmessage = (event) => {
      const binaryData = event.data;

      if (binaryData instanceof Blob) {
        binaryData.arrayBuffer().then((arrayBuffer) => {
          audioContext.decodeAudioData(arrayBuffer, (decodedData) => {
            audioBufferQueue.push(decodedData);
            playAudioBuffer();
          });
        });
      }
    };

    function playAudioBuffer() {
      if (!sourceNode && audioBufferQueue.length > 0) {
        const buffer = audioBufferQueue.shift();
        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = buffer;
        sourceNode.connect(audioContext.destination);
        sourceNode.start();
        sourceNode.onended = () => {
          sourceNode = null;
          playAudioBuffer();
        };
      }
    }
  </script>
</body>
</html>
